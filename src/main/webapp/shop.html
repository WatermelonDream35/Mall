<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>商城</title>
</head>
<body>
<div id="app">
    <template>
        <!--页头-->
        <el-container>
            <el-header class="title">
                欢迎来到种花家商店！
            </el-header>
            <el-header class="settings">
                <el-dropdown trigger="click">
                    <span class="el-dropdown-link">
                        设置<i class="el-icon-arrow-down el-icon--right"></i>
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item v-if="isUser && !isVisitor" @click.native="pwdDialogVisible = true">修改密码
                        </el-dropdown-item>

                        <el-dialog title="修改密码"
                                   :visible.sync="pwdDialogVisible"
                                   :append-to-body="true"
                                   width="30%">
                            <el-form
                                    id="pwdForm"
                                    :model="pwdForm"
                                    :rules="pwdFormRules"
                                    ref="pwdForm"
                                    label-width="100px"
                                    label-position="right">

                                <el-form-item label="旧密码:" prop="oldPassword">
                                    <el-input v-model="pwdForm.oldPassword" type="password"
                                              auto-complete="off">
                                    </el-input>
                                </el-form-item>
                                <el-form-item label="新密码:" prop="newPassword" label-width="100px">
                                    <el-input v-model="pwdForm.newPassword" type="password"
                                              auto-complete="off">
                                    </el-input>
                                </el-form-item>
                                <el-form-item label="确认密码:" prop="confirmPassword" label-width="100px">
                                    <el-input v-model="pwdForm.confirmPassword" type="password"
                                              auto-complete="off">
                                    </el-input>
                                </el-form-item>
                            </el-form>

                            <div slot="footer" class="dialog-footer" style="margin-top: 5px;">
                                <el-button @click.native="pwdDialogVisible = false">取 消</el-button>
                                <el-button type="primary" @click.native="submitForm('pwdForm')">确 定
                                </el-button>
                            </div>
                        </el-dialog>

                        <el-dropdown-item @click.native="logout">注销</el-dropdown-item>
                    </el-dropdown-menu>
                </el-dropdown>

                <span>欢迎您，{{username}}</span>

            </el-header>

            <el-card>
                <el-tabs v-model="activeName" @tab-click="handleClick">
                    <!--商品信息-->
                    <el-tab-pane label="商品信息" name="first">
                        <el-main>
                            <el-row style="height: 60px;">
                                <!--搜索框-->
                                <el-col :span="8" :offset="8">
                                    <el-input
                                            placeholder="请输入内容"
                                            v-model="input"
                                            class="input-with-select">
                                        <el-select
                                                style="width: 110px;"
                                                v-model="select"
                                                slot="prepend"
                                                placeholder="请选择">
                                            <el-option label="商品名称" value="goodsName"></el-option>
                                            <el-option label="类型" value="type"></el-option>
                                            <el-option label="描述" value="description"></el-option>
                                        </el-select>
                                        <el-button
                                                slot="append"
                                                icon="el-icon-search"
                                                @click="selectGoods"></el-button>
                                    </el-input>

                                </el-col>
                                <el-col v-if="!isUser">
                                    <el-button type="danger" icon="el-icon-delete" @click="deleteByIds">
                                        批量删除
                                    </el-button>
                                </el-col>
                                <el-col :span="3" :offset="21" v-if="!isUser">
                                    <el-button type="success" icon="el-icon-circle-plus-outline"
                                               @click="addDialogVisible = true">
                                        添加商品
                                    </el-button>

                                    <!--添加数据对话框表单-->
                                    <el-dialog
                                            title="添加商品"
                                            :visible.sync="addDialogVisible"
                                            width="30%"
                                            center
                                    >

                                        <el-form ref="form" :model="goods" label-width="80px">

                                            <el-form-item label="商品名称">
                                                <el-input v-model="goods.goodsName"></el-input>
                                            </el-form-item>

                                            <el-form-item label="图片路径">
                                                <el-input v-model="goods.img"></el-input>
                                            </el-form-item>

                                            <el-form-item label="价格">
                                                <el-input v-model="goods.price"></el-input>
                                            </el-form-item>

                                            <el-form-item label="库存">
                                                <el-input v-model="goods.stockNumber"></el-input>
                                            </el-form-item>


                                            <el-form-item label="类型">
                                                <el-input v-model="goods.type"></el-input>
                                            </el-form-item>

                                            <el-form-item label="描述">
                                                <el-input type="textarea" v-model="goods.description"></el-input>
                                            </el-form-item>

                                            <el-form-item>
                                                <el-button type="primary" @click="addGoods">提交</el-button>
                                                <el-button @click="addDialogVisible = false">取消</el-button>
                                            </el-form-item>
                                        </el-form>

                                    </el-dialog>

                                </el-col>
                            </el-row>

                            <!--商品表格-->
                            <el-table
                                    :data="tableData"
                                    stripe
                                    style="width: 100%"
                                    :cell-style="{textAlign:'center'}"
                                    :header-cell-style="{textAlign:'center'}"
                                    @selection-change="handleSelectionChange">

                                <!-- 复选框 -->
                                <el-table-column
                                        v-if="!isUser"
                                        type="selection"
                                        width="55"></el-table-column>

                                <el-table-column type="expand">
                                    <template slot-scope="props">
                                        <el-form label-position="left" inline class="table-expand">
                                            <el-form-item label="商品 ID">
                                                <span>{{ props.row.id }}</span>
                                            </el-form-item>
                                            <el-form-item label="商品名称">
                                                <span>{{ props.row.goodsName }}</span>
                                            </el-form-item>
                                            <el-form-item label="图片路径">
                                                <span>{{ props.row.img }}</span>
                                            </el-form-item>
                                            <el-form-item label="价格">
                                                <span>{{ props.row.price }}</span>
                                            </el-form-item>
                                            <el-form-item label="库存">
                                                <span>{{ props.row.stockNumber }}</span>
                                            </el-form-item>
                                            <el-form-item label="购买数量">
                                                <span>{{ props.row.buyNumber }}</span>
                                            </el-form-item>
                                            <el-form-item label="销量">
                                                <span>{{ props.row.salesNumber }}</span>
                                            </el-form-item>
                                            <el-form-item label="类型">
                                                <span>{{ props.row.type }}</span>
                                            </el-form-item>
                                            <el-form-item label="描述">
                                                <span>{{ props.row.description }}</span>
                                            </el-form-item>
                                        </el-form>
                                    </template>
                                </el-table-column>

                                <el-table-column
                                        label="商品 ID"
                                        prop="id"
                                        sortable>
                                </el-table-column>

                                <el-table-column
                                        label="商品名称"
                                        prop="goodsName"
                                        sortable>
                                </el-table-column>

                                <el-table-column label="商品图片" prop="img">
                                    <template slot-scope="scope">
                                        <el-popover
                                                placement="right"
                                                width="150"
                                                trigger="click">
                                            <img :src="scope.row.img" class="imgStyle"/>
                                            <img slot="reference"
                                                 :src="scope.row.img"
                                                 style="max-height: 150px;max-width: 150px">
                                        </el-popover>
                                    </template>
                                </el-table-column>

                                <el-table-column
                                        label="单价"
                                        prop="price"
                                        sortable>
                                </el-table-column>

                                <el-table-column
                                        label="销量"
                                        prop="salesNumber"
                                        sortable>
                                </el-table-column>

                                <el-table-column
                                        label="库存"
                                        prop="stockNumber"
                                        sortable>
                                </el-table-column>

                                <el-table-column label="操作">
                                    <template slot-scope="scope">
                                        <el-button
                                                size="medium"
                                                type="primary"
                                                icon="el-icon-shopping-cart-2"
                                                v-if="isUser"
                                                @click="handleAdd(scope.$index)">加入购物车
                                        </el-button>

                                        <el-button type="primary"
                                                   icon="el-icon-edit"
                                                   v-if="!isUser"
                                                   @click="updateDialogVisible = true;
                                                   setCurrentGoods(scope.row.id)">修改
                                        </el-button>

                                        <!--添加数据对话框表单-->
                                        <el-dialog
                                                title="修改商品信息"
                                                :visible.sync="updateDialogVisible"
                                                width="30%"
                                                center
                                        >
                                            <el-form ref="form" v-model="currentGoods" label-width="80px">

                                                <el-form-item label="商品名称">
                                                    <el-input v-model="currentGoods.goodsName"></el-input>
                                                </el-form-item>

                                                <el-form-item label="图片路径">
                                                    <el-input v-model="currentGoods.img"></el-input>
                                                </el-form-item>

                                                <el-form-item label="价格">
                                                    <el-input v-model="currentGoods.price"></el-input>
                                                </el-form-item>

                                                <el-form-item label="库存">
                                                    <el-input v-model="currentGoods.stockNumber"></el-input>
                                                </el-form-item>

                                                <el-form-item label="类型">
                                                    <el-input v-model="currentGoods.type"></el-input>
                                                </el-form-item>

                                                <el-form-item label="描述">
                                                    <el-input v-model="currentGoods.description"></el-input>
                                                </el-form-item>

                                                <el-form-item>
                                                    <el-button type="primary" @click="updateGoods">提交</el-button>
                                                    <el-button @click="updateDialogVisible = false">取消</el-button>
                                                </el-form-item>
                                            </el-form>

                                        </el-dialog>

                                        <el-button type="danger"
                                                   icon="el-icon-delete"
                                                   v-if="!isUser"
                                                   @click="deleteGoods(scope.row.id)">删除
                                        </el-button>
                                    </template>
                                </el-table-column>
                            </el-table>

                            <!--分页工具条-->
                            <el-pagination
                                    @size-change="handleSizeChange"
                                    @current-change="handleCurrentChange"
                                    :current-page="currentPage"
                                    :page-sizes="[5, 10, 15, 20]"
                                    :page-size="5"
                                    layout="total, sizes, prev, pager, next, jumper"
                                    :total="totalCount">
                            </el-pagination>
                        </el-main>
                    </el-tab-pane>

                    <!--购物车-->
                    <el-tab-pane label="购物车" name="second" v-if="isUser">
                        <!--商品表格-->
                        <el-table
                                :data="addedGoods"
                                stripe
                                style="width: 100%"
                                :cell-style="{textAlign:'center'}"
                                :header-cell-style="{textAlign:'center'}"
                                @select="handleSum"
                                @select-all="handleSum"
                                ref="multipleTable">

                            <!-- 复选框 -->
                            <el-table-column type="selection" width="55"></el-table-column>

                            <el-table-column
                                    label="商品 ID"
                                    prop="id"
                                    sortable>
                            </el-table-column>

                            <el-table-column label="商品图片" prop="img">
                                <template slot-scope="scope">
                                    <el-popover
                                            placement="right"
                                            width="150"
                                            trigger="click">
                                        <img :src="scope.row.img" class="imgStyle"/>
                                        <img slot="reference"
                                             :src="scope.row.img"
                                             style="max-height: 100px;max-width: 100px">
                                    </el-popover>
                                </template>
                            </el-table-column>

                            <el-table-column
                                    label="商品名称"
                                    prop="goodsName"
                                    sortable>
                            </el-table-column>

                            <el-table-column
                                    label="单价"
                                    prop="price"
                                    sortable>
                            </el-table-column>

                            <el-table-column label="购买数量">
                                <!-- 使用计数器来添加数量，绑定表格数据行对应的count -->
                                <template slot-scope="scope">
                                    <el-input-number v-model="scope.row.buyNumber"
                                                     :min="1"
                                                     :max="scope.row.stockNumber"
                                                     @change="handleUpdate()">
                                    </el-input-number>
                                </template>
                            </el-table-column>

                            <el-table-column
                                    label="金额"
                                    prop="sumPrice"
                                    sortable>
                                <template slot-scope="money">
                                    <span>￥{{money.row.price*money.row.buyNumber}}</span>
                                </template>
                            </el-table-column>

                            <el-table-column label="操作" min-width="100">
                                <template slot-scope="scope">
                                    <el-button size="medium"
                                               type="danger"
                                               icon="el-icon-delete"
                                               @click="handleDelete(scope.$index)">删除
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>


                        <el-row>
                            <el-col style="margin: 20px;">
                                总价：<span style="color: red;">￥{{sum}}</span>
                            </el-col>

                            <el-col :offset="21">
                                <el-button
                                        size="medium"
                                        type="primary"
                                        icon="el-icon-coin"
                                        @click="handleCheck">全部购买
                                </el-button>

                            </el-col>

                            <el-dialog title="请输入图片中的文字"
                                       width="40%"
                                       :visible.sync="inputDialogFormVisible">

                                <el-row>
                                    <audio id="bgm">
                                        <source src="bgm.mp3">
                                    </audio>
                                    <el-col :offset="19">
                                        <el-button icon="el-icon-video-play" circle @click="bgmPlay"></el-button>
                                        <el-button icon="el-icon-video-pause" circle @click="bgmPause"></el-button>
                                    </el-col>
                                </el-row>

                                <el-form :rules="inputTextRules"
                                         :model="inputForm"
                                         ref="inputForm">
                                    <el-form-item style="display: flex;justify-content: center;align-items: center">
                                        <el-image
                                                style="width: 250px"
                                                src="http://img1.ali213.net/glpic/2022/09/01/584_2022090115745357.png">
                                        </el-image>
                                    </el-form-item>

                                    <el-form-item style="display: flex;justify-content: center;align-items: center;"
                                                  prop="inputText">
                                        <el-input style="width: 300px"
                                                  placeholder="点击右上角播放按钮有惊喜"
                                                  v-model="inputForm.inputText">
                                        </el-input>
                                    </el-form-item>
                                </el-form>
                                <div slot="footer" class="dialog-footer">
                                    <el-button @click.native="inputDialogFormVisible = false">取 消</el-button>
                                    <el-button type="primary" @click.native="submitForm('inputForm')">确 定</el-button>
                                </div>
                            </el-dialog>
                        </el-row>

                    </el-tab-pane>

                    <!--销售报表-->
                    <el-tab-pane label="销售报表" name="third" v-loading="chartLoading" v-if="!isUser">
                        <el-row>
                            <el-col :span="12" style="text-align: center">
                                <el-card>
                                    <div id="orderChart" style="width:700px;height:300px;float:left;"></div>
                                </el-card>
                            </el-col>
                            <el-col :span="12">
                                <el-card>
                                    <div id="salesChart" style="width:700px;height:300px;float:left;"></div>
                                </el-card>
                            </el-col>
                        </el-row>

                        <el-row>
                            <el-col :span="8">
                                <el-card>
                                    <div id="goodsChart" style="width:480px;height:400px;float:left;"></div>
                                </el-card>
                            </el-col>
                            <el-col :span="8">
                                <el-card>
                                    <div id="typeChart" style="width:480px;height:400px;float:left;"></div>
                                </el-card>
                            </el-col>
                            <el-col :span="8">
                                <el-card>
                                    <div id="userChart" style="width:480px;height:400px;float:left;"></div>
                                </el-card>
                            </el-col>
                        </el-row>

                    </el-tab-pane>

                    <!--订单管理-->
                    <el-tab-pane label="订单管理" name="forth" v-if="!isVisitor">
                        <!--商品表格-->
                        <el-table
                                :data="ordersData"
                                stripe
                                style="width: 100%"
                                :cell-style="{textAlign:'center'}"
                                :header-cell-style="{textAlign:'center'}">

                            <el-table-column
                                    label="订单号"
                                    prop="orderId"
                                    sortable>
                            </el-table-column>

                            <el-table-column
                                    label="用户名"
                                    prop="username"
                                    sortable>
                            </el-table-column>

                            <el-table-column
                                    label="总价"
                                    prop="totalPrice"
                                    sortable>
                            </el-table-column>

                            <el-table-column
                                    label="购买时间"
                                    prop="time"
                                    sortable>
                            </el-table-column>

                            <el-table-column
                                    label="状态"
                                    prop="status"
                                    sortable>
                            </el-table-column>

                            <el-table-column label="订单详情">
                                <template slot-scope="scope">
                                    <el-link type="primary"
                                             icon="el-icon-view"
                                             @click="showOrderDetail(scope.row.orderId)">查看订单详情
                                    </el-link>
                                </template>
                            </el-table-column>

                            <el-table-column label="操作" min-width="100">
                                <template slot-scope="scope">
                                    <el-button size="medium"
                                               type="warning"
                                               icon="el-icon-sell"
                                               :disabled="scope.row.status != '未发货'?true:false"
                                               v-if="!isUser"
                                               @click="sendOrder(scope.row)">立即发货
                                    </el-button>

                                    <el-button size="medium"
                                               type="success"
                                               icon="el-icon-box"
                                               :disabled="scope.row.status != '已发货'?true:false"
                                               v-if="isUser"
                                               @click="receiveOrder(scope.row)">确认收货
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>

                    </el-tab-pane>

                </el-tabs>

            </el-card>

        </el-container>
    </template>

</div>

<style>
    /*页头*/
    .title {
        height: 10px !important;
        text-align: center;
        font-size: 32px;
        font-family: "微軟正黑體", serif;
    }

    .settings {
        text-align: right;
        height: 60px !important;
        line-height: 80px;
        font-size: 20px;
        color: #333;
    }

    /*设置*/
    .el-dropdown-link {
        font-size: 20px;
        cursor: pointer;
        color: #409EFF;
    }

    .el-icon-arrow-down {
        font-size: 12px;
    }


    /*商品详情*/
    .table-expand {
        font-size: 0;
    }

    .table-expand label {
        width: 90px;
        color: #99a9bf;
    }

    .table-expand .el-form-item {
        margin-right: 0;
        margin-bottom: 0;
        width: 50%;
    }


</style>


<script src="js/vue.js"></script>
<script src="element-ui/lib/index.js"></script>
<link rel="stylesheet" href="element-ui/lib/theme-chalk/index.css">
<script src="echarts/echarts.min.js"></script>

<script src="js/axios-0.18.0.js"></script>

<script>

    //注册组件
    Vue.prototype.$echarts = echarts

    new Vue({
        el: "#app",

        mounted() {
            this.role();
            this.showTableData();
        },

        data() {
            // 密码验证规则
            var checkOldPwd = (rule, value, callback) => {
                if (!value) {
                    return callback(new Error('请输入旧密码'));
                }
                this.checkIsRepeat(value, function () { //检查原密码是否正确
                    callback();
                }, function (err) {
                    callback(new Error('原密码错误'));
                })
            };
            var checkNewPwd = (rule, value, callback) => { //检查新旧密码是否相同
                if (!value) {
                    return callback(new Error('请输入新密码'));
                }
                if (this.pwdForm.oldPassword === value) {
                    callback(new Error("新密码不能与旧密码相同"));
                } else if (value.length < 6 || value.length > 12) {
                    callback(new Error("密码长度需在6-12位之间"));
                } else {
                    callback()
                }
            };
            var checkConfirmPwd = (rule, value, callback) => { //检查两次密码输入是否相同
                if (!value) {
                    return callback(new Error('请再次输入密码'));
                }
                if (this.pwdForm.newPassword !== value) {
                    callback(new Error("两次输入的密码不一致"));
                } else {
                    callback()
                }
            };

            // 图片文字校验
            var checkInputText = (rule, value, callback) => { //检查输入信息是否与图片文字相符
                if (!value) {
                    return callback(new Error('请输入图片上的文字'));
                }
                if ("任何邪恶终将绳之以法" !== value) {
                    callback(new Error("输入信息与图片文字不符"));
                } else {
                    callback()
                }
            };


            return {
                // 当前用户
                userId: null,
                username: "管理员",
                // 部件显示情况
                isUser: false,
                isVisitor: false,

                // 修改密码
                pwdDialogVisible: false,
                pwdForm: {
                    oldPassword: '',
                    newPassword: '',
                    confirmPassword: ''
                },
                pwdFormRules: {
                    oldPassword: [{
                        required: true,
                        validator: checkOldPwd,
                        trigger: 'blur'
                    }],
                    newPassword: [{
                        required: true,
                        validator: checkNewPwd,
                        trigger: 'blur'
                    }],
                    confirmPassword: [{
                        required: true,
                        validator: checkConfirmPwd,
                        trigger: 'blur'
                    }]
                },

                // 搜索框
                select: "goodsName",
                input: "",
                queryCondition: {
                    goodsName: "",
                    type: "",
                    description: ""
                },

                // 添加商品
                // 添加数据对话框是否展示的标记
                addDialogVisible: false,

                // 修改商品
                // 添加数据对话框是否展示的标记
                updateDialogVisible: false,
                currentGoods: {
                    id: "",
                    goodsName: '',
                    img: "",
                    price: "",
                    stockNumber: "",
                    buyNumber: "",
                    salesNumber: "",
                    type: "",
                    description: ""
                },

                // 删除商品
                // 被选中的id数组
                selectedIds: [],
                // 复选框选中数据集合
                multipleSelection: [],

                //标签页
                activeName: 'first',

                //分页
                // 每页显示的条数
                pageSize: 5,
                // 总记录数
                totalCount: 100,
                // 当前页码
                currentPage: 1,

                // 商品列表
                goods: {
                    id: "",
                    goodsName: '',
                    img: "",
                    price: "",
                    stockNumber: "",
                    buyNumber: "",
                    salesNumber: "",
                    type: "",
                    description: ""
                },

                tableData: [{
                    id: "1",
                    goodsName: "好滋好味鸡蛋仔",
                    img: "https://cp1.douguo.com/upload/caiku/0/9/6/yuan_0982360ec9f7f3a7f720c04ced479536.jpg",
                    price: "10",
                    stockNumber: "10",
                    buyNumber: "0",
                    salesNumber: "1",
                    type: "小吃",
                    description: "荷兰优质淡奶，奶香浓而不腻",
                }, {
                    id: "2",
                    goodsName: "好滋好味鸡蛋仔",
                    img: "https://cp1.douguo.com/upload/caiku/0/9/6/yuan_0982360ec9f7f3a7f720c04ced479536.jpg",
                    price: "10",
                    stockNumber: "10",
                    buyNumber: "0",
                    salesNumber: "1",
                    type: "小吃",
                    description: "荷兰优质淡奶，奶香浓而不腻",
                }, {
                    id: "3",
                    goodsName: "好滋好味鸡蛋仔",
                    img: "https://cp1.douguo.com/upload/caiku/0/9/6/yuan_0982360ec9f7f3a7f720c04ced479536.jpg",
                    price: "10",
                    stockNumber: "10",
                    buyNumber: "0",
                    salesNumber: "1",
                    type: "小吃",
                    description: "荷兰优质淡奶，奶香浓而不腻",
                }, {
                    id: "4",
                    goodsName: "好滋好味鸡蛋仔",
                    img: "https://cp1.douguo.com/upload/caiku/0/9/6/yuan_0982360ec9f7f3a7f720c04ced479536.jpg",
                    price: "10",
                    stockNumber: "10",
                    buyNumber: "0",
                    salesNumber: "1",
                    type: "小吃",
                    description: "荷兰优质淡奶，奶香浓而不腻",
                }],

                //购物车
                sum: 0,
                // 添加进购物车的商品数组
                addedGoods: [],

                inputDialogFormVisible: false,
                inputForm: {
                    inputText: '',
                },
                inputTextRules: {
                    inputText: [{
                        required: true,
                        validator: checkInputText,
                        trigger: 'blur'
                    }],
                },

                //订单
                order: {
                    orderId: '',
                    userId: '',
                    totalPrice: "",
                    time: "",
                    status: ""
                },
                ordersData: [],

                //销售报表
                orderChart: '',
                salesChart: '',
                goodsChart: '',
                typeChart: '',
                userChart: '',

                chartItemData: {
                    value: 0,
                    name: '',
                },

                orderData: [],
                salesData: [],
                goodsData: [],
                typeData: [],
                userData: [],

                chartLoading: false
            }
        },

        methods: {
            //处理页头点击
            handleClick(tab) {
                if ('third' === tab.name) { //销售报表
                    this.getChartsData();
                    this.chartLoading = true;
                    setTimeout(() => {
                        this.drawLine();
                        this.chartLoading = false;
                    }, 1000);
                }
                if ('forth' === tab.name) { //订单管理
                    this.showOrdersData();
                }
            },

            // 获取url参数
            getQueryVariable(variable) {
                let query = window.location.search.substring(1);
                let vars = query.split("&");
                for (let i = 0; i < vars.length; i++) {
                    let pair = vars[i].split("=");
                    if (pair[0] === variable) {
                        return pair[1];
                    }
                }
                return null;
            },

            //判断是用户还是管理员
            async role() {
                this.userId = this.getQueryVariable('userId');
                console.log(this.userId)
                //游客
                if (this.userId === null) {
                    this.isUser = true;
                    this.isVisitor = true;
                    this.username = "游客";
                    return;
                }

                if (this.userId !== -1) {
                    this.isUser = true;
                    this.isVisitor = false;
                    await this.getUsername(this.userId).then(res => {
                        this.username = res;
                    })
                } else {
                    this.isUser = false;
                    this.isVisitor = false;
                    this.username = "管理员";
                }

            },

            logout() {
                this.$confirm('确定要退出账号吗?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    //跳转页面
                    window.location.href = 'http://localhost:8080/Mall/login.html';
                })
            },

            // 获取用户名
            async getUsername(userId) {
                // 发送ajax请求，请求数据
                let username = ''
                await axios({
                    method: "get",
                    url: "http://localhost:8080/Mall/user/getUsernameById?id=" + userId,
                }).then(resp => {
                    //设置返回值username
                    username = resp.data;
                })
                return username
            },


            //修改密码
            // 校验旧密码
            checkIsRepeat(oldPwd, success, error) {
                if (!oldPwd) return;

                axios({
                    method: "get",
                    url: "http://localhost:8080/Mall/user/selectByUsername?username=" + this.username,
                }).then(resp => {
                    let realPwd = resp.data["password"];

                    // 进行比对
                    if (oldPwd === realPwd) {
                        success()
                    } else {
                        error()
                    }
                })

            },

            // 点击确定按钮
            submitForm(formName) {
                this.$refs[formName].validate((valid) => {
                    if (formName === "pwdForm") {
                        if (valid) {
                            this.updatePwd();
                        } else {
                            this.$message.error('请正确输入密码！');
                            return false;
                        }
                    } else if (formName === "inputForm") {
                        if (valid) {
                            this.handleBuy();
                        } else {
                            this.$message.error('请正确输入图片文字！');
                            return false;
                        }
                    }

                });
            },

            //修改密码，调用接口更改
            updatePwd() {
                // 发送ajax请求，请求数据
                axios({
                    method: "get",
                    url: "http://localhost:8080/Mall/user/updatePwd?id=" + this.userId + "&password=" + this.pwdForm.newPassword,
                }).then(resp => {
                    if (resp.data === "success") {
                        this.$message({
                            message: '修改密码成功',
                            type: "success"
                        });
                        this.pwdDialogVisible = false;
                        document.getElementById("pwdForm").reset();
                    }
                })
            },

            //商品列表
            // 查询分页数据
            showTableData() {
                // 发送ajax请求，请求数据
                axios({
                    method: "post",
                    url: "http://localhost:8080/Mall/goods/selectByPageAndCondition?currentPage=" + this.currentPage + "&pageSize=" + this.pageSize,
                    data: this.queryCondition
                }).then(resp => {
                    //设置表格数据
                    this.tableData = resp.data.rows; // {rows:[],totalCount:100}
                    //设置总记录数
                    this.totalCount = resp.data.totalCount;
                })
            },

            selectAll() {
                // 发送ajax请求，请求数据
                axios({
                    method: "post",
                    url: "http://localhost:8080/Mall/goods/selectAll",
                }).then(resp => {
                    //设置表格数据
                    this.tableData = resp.data;
                })
            },

            // 设置当前选中的商品信息
            setCurrentGoods(id) {
                this.tableData.forEach(item => {
                    if (item.id === id) {
                        // 对引用数据类型进行克隆传值（即转为JSON格式），防止直接复制传址造成的原数据同步修改
                        this.currentGoods = JSON.parse(JSON.stringify(item));
                    }
                })
            },

            //复选框
            // 复选框选中后执行的方法
            handleSelectionChange(val) {
                this.multipleSelection = val;

            },

            //分页
            handleSizeChange(val) {
                // 重新设置每页显示的条数
                this.pageSize = val;
                this.showTableData();
            },
            handleCurrentChange(val) {
                // 重新设置当前页码
                this.currentPage = val;
                this.showTableData();
            },

            //搜索框
            selectGoods() {
                //初始化
                this.queryCondition = {
                    goodsName: '',
                    type: "",
                    description: ""
                };

                switch (this.select) {
                    case "goodsName":
                        this.queryCondition.goodsName = this.input;
                        break;
                    case "type":
                        this.queryCondition.type = this.input;
                        break;
                    case "description":
                        this.queryCondition.description = this.input;
                        break;
                }

                this.showTableData();

                setTimeout(() => { // 异步查询返回数据较慢，需延缓一会
                    if (this.totalCount !== 0) {
                        this.$message({
                            message: '共查询到 ' + this.totalCount + ' 个符合要求的商品',
                            type: "success"
                        });
                    } else {
                        this.$message.error('没有符合条件的商品');
                    }
                }, 100);


            },

            //添加商品
            addGoods() {
                // 发送ajax请求，添加数据
                axios({
                    method: "post",
                    url: "http://localhost:8080/Mall/goods/add",
                    data: this.goods
                }).then((resp) => {
                    if (resp.data === "success") {
                        //关闭窗口
                        this.addDialogVisible = false;

                        // 重新查询数据
                        this.showTableData();
                        // 弹出消息提示
                        this.$message({
                            message: '恭喜你，添加成功',
                            type: 'success'
                        });
                    }
                })
            },

            //修改商品
            updateGoods() {
                // 发送ajax请求，添加数据
                axios({
                    method: "post",
                    url: "http://localhost:8080/Mall/goods/update",
                    data: this.currentGoods
                }).then((resp) => {
                    if (resp.data === "success") {
                        //关闭窗口
                        this.updateDialogVisible = false;

                        // 重新查询数据
                        this.showTableData();
                        // 弹出消息提示
                        this.$message({
                            message: '恭喜你，修改成功',
                            type: 'success'
                        });
                    }
                })
            },

            //删除商品
            deleteGoods(id) {
                this.$confirm('确定删除该商品吗?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    //用户点击确认按钮
                    // 发送ajax请求，添加数据
                    axios({
                        method: "get",
                        url: "http://localhost:8080/Mall/goods/delete?id=" + id,
                    }).then((resp) => {
                        if (resp.data === "success") {
                            // 重新查询数据
                            this.showTableData();
                            // 弹出消息提示
                            this.$message({
                                message: "已成功删除该商品",
                                type: 'success'
                            });
                        }
                    })
                }).catch(() => {
                    //用户点击取消按钮
                    this.$message({
                        type: 'info',
                        message: '已取消删除'
                    });
                });
            },

            deleteByIds() {
                // 弹出确认提示框
                if (this.multipleSelection.length === 0) {
                    this.$message({
                        message: "未选中任何商品！",
                        type: 'info'
                    });
                    return;
                }
                this.$confirm('确定删除当前选中的 ' + this.multipleSelection.length + ' 个商品吗?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    //用户点击确认按钮

                    //1. 创建id数组 [1,2,3], 从 this.multipleSelection 获取即可
                    for (let i = 0; i < this.multipleSelection.length; i++) {
                        let selectionElement = this.multipleSelection[i];
                        this.selectedIds[i] = selectionElement.id;

                    }

                    //2. 发送AJAX请求

                    // 发送ajax请求，删除数据
                    axios({
                        method: "post",
                        url: "http://localhost:8080/Mall/goods/deleteByIds",
                        data: this.selectedIds
                    }).then((resp) => {
                        if (resp.data === "success") {
                            // 重新查询数据
                            this.showTableData();
                            // 弹出消息提示
                            this.$message({
                                message: "已成功删除" + this.multipleSelection.length + "个商品",
                                type: 'success'
                            });
                        }
                    })
                }).catch(() => {
                    //用户点击取消按钮

                    this.$message({
                        type: 'info',
                        message: '已取消删除'
                    });
                });
            },

            //购物车
            // 计算总额
            handleSum() {
                this.sum = 0;
                this.$nextTick(() => {
                    // console.log(this.$refs.multipleTable.selection);
                    // this.$refs.multipleTable.selection获取被选中的行
                    this.$refs.multipleTable.selection.forEach(item => {
                        this.sum += (item.price * item.buyNumber)
                    });
                })
            },
            // 添加操作
            handleAdd(i) {
                // 判断库存是否为0
                if (this.tableData[i].stockNumber - this.tableData[i].buyNumber <= 0) {
                    this.$message.error('此商品缺货中，暂时无法购买');
                    return;
                }

                let flag = false;
                this.addedGoods.forEach(item => {
                    if (item.id === this.tableData[i].id) {
                        item.buyNumber++;
                        this.handleSum();
                        flag = true;
                    }
                })
                if (!flag) {
                    this.tableData[i].buyNumber = 1;
                    this.addedGoods.push(this.tableData[i]);
                }
                this.$message({
                    message: '已添加到购物车',
                    type: 'success'
                });

            },
            // 修改操作
            handleUpdate() {
                this.handleSum();
            },
            // 删除操作
            handleDelete(i) {
                this.addedGoods.splice(i, 1);
                this.tableData[i].buyNumber = 0;
                this.handleSum();
            },

            // 购买验证
            handleCheck() {
                if (this.$refs.multipleTable.selection.length === 0) {
                    this.$message.error('请选择要购买的商品');
                    return;
                }

                this.$confirm('确认购买这些商品吗?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    // 游客
                    if (this.isVisitor) {
                        this.$message.error('请先登录！');

                        setTimeout(() => {
                            //跳转页面
                            window.location.href = 'http://localhost:8080/Mall/login.html'
                        }, 1000);
                    } else {
                        this.inputDialogFormVisible = true;
                    }

                }).catch(() => {
                    //用户点击取消按钮
                    this.$message({
                        type: 'info',
                        message: '已取消购买'
                    });
                });
            },
            // 验证bgm
            bgmPlay() {
                document.getElementById('bgm').play();
            },
            bgmPause() {
                document.getElementById('bgm').pause();
            },

            // 购买操作
            handleBuy() {
                // 发送ajax请求，添加数据
                axios({
                    method: "post",
                    url: "http://localhost:8080/Mall/order/createOrder?totalPrice=" + this.sum + "&userId=" + this.userId,
                    data: this.$refs.multipleTable.selection // 购物车中选中商品
                }).then((resp) => {
                    this.inputDialogFormVisible = false;
                    // 重新查询数据
                    this.showTableData();
                    this.showOrdersData();

                    // 删除购物车中已购买的商品
                    this.$refs.multipleTable.selection.forEach((val, index) => {
                        //遍历源数据
                        this.addedGoods.forEach((v, i) => {
                            //如果选中数据和源数据相等，删除对应的源数据
                            if (val === v) {
                                this.handleDelete(i)
                            }
                        })
                    })

                    // 弹出订单信息
                    let orderString = '<pre><strong>订单号：\t' + resp.data['orderId'] + '<br/>' +
                        '用户名：\t' + this.username + '<br/>' +
                        '总价：\t\t￥' + resp.data['totalPrice'] + '<br/>' +
                        '购买时间：\t' + resp.data['time'] + '<br/>' +
                        '当前状态：\t' + '未发货' + '<br/></strong></pre>';

                    this.$notify({
                        title: '购买成功',
                        message: orderString,
                        type: 'success',
                        dangerouslyUseHTMLString: true,
                    });

                })

            },


            // 订单管理
            // 查询订单数据
            showOrdersData() {
                // 判断查询角色
                let method;
                if (this.isUser === true) {
                    method = "showMyOrders?userId=" + this.userId;
                } else {
                    method = "showAllOrders";
                }

                // 发送ajax请求，请求数据
                axios({
                    method: "get",
                    url: "http://localhost:8080/Mall/order/" + method,
                }).then(resp => {
                    //处理表格数据
                    resp.data.forEach(async (item) => {
                        await this.getUsername(item.userId).then(res => {
                            item.username = res;
                        })
                        switch (item.status) {
                            case 0:
                                item.status = '未发货';
                                break;
                            case 1:
                                item.status = '已发货';
                                break;
                            case 2:
                                item.status = '已签收';
                                break;
                        }
                    })

                    //设置表格数据
                    this.ordersData = resp.data;
                })
            },

            // 显示订单详情
            showOrderDetail(orderId) {
                axios({
                    method: "post",
                    url: "http://localhost:8080/Mall/order/showOrderDetail?orderId=" + orderId,
                }).then((resp) => {
                    let orderItemsString = '';
                    resp.data.forEach(orderItems => {
                        orderItemsString += '<pre><strong>' + orderItems['name'] +
                            '\t<i>￥' + orderItems['price'] +
                            '</i>&nbsp;*&nbsp;' + orderItems['count'] + '\n</strong></pre>';
                    })

                    this.$alert(orderItemsString, '订单详情', {
                        confirmButtonText: '确定',
                        dangerouslyUseHTMLString: true,
                    });

                })
            },

            //发货
            sendOrder(order) {
                this.$confirm('确认发货吗?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    //用户点击确认按钮
                    // 发送ajax请求，添加数据

                    order['status'] = '0';
                    axios({
                        method: "post",
                        url: "http://localhost:8080/Mall/order/sendOrder",
                        data: order
                    }).then((resp) => {
                        // 重新查询数据
                        this.showOrdersData();

                        this.$message({
                            type: 'success',
                            message: '发货成功'
                        });

                    })
                }).catch(() => {
                    //用户点击取消按钮
                    this.$message({
                        type: 'info',
                        message: '已取消发货'
                    });
                });
            },

            //收货
            receiveOrder(order) {
                this.$confirm('确认收货吗?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    //用户点击确认按钮
                    // 发送ajax请求，添加数据

                    order['status'] = '1';
                    axios({
                        method: "post",
                        url: "http://localhost:8080/Mall/order/receiveOrder",
                        data: order
                    }).then((resp) => {
                        // 重新查询数据
                        this.showOrdersData();

                        this.$message({
                            type: 'success',
                            message: '收货成功'
                        });

                    })
                }).catch(() => {
                    //用户点击取消按钮
                    this.$message({
                        type: 'info',
                        message: '已取消收货'
                    });
                });
            },

            // 销售报表
            getChartsData() {
                axios({
                    method: "get",
                    url: "http://localhost:8080/Mall/order/sortByStatusCount",
                }).then((resp) => {
                    for (let i = 0; i < resp.data.length; i++) {
                        switch (resp.data[i]["name"]) {
                            case 0:
                                this.chartItemData.name = '未发货';
                                break;
                            case 1:
                                this.chartItemData.name = '已发货';
                                break;
                            case 2:
                                this.chartItemData.name = '已签收';
                                break;
                        }
                        this.chartItemData.value = resp.data[i]["value"];

                        this.orderData[i] = JSON.parse(JSON.stringify(this.chartItemData));
                    }
                    //console.log(this.orderData)
                });
                axios({
                    method: "get",
                    url: "http://localhost:8080/Mall/order/sortByStatusPrice",
                }).then((resp) => {
                    for (let i = 0; i < resp.data.length; i++) {
                        switch (resp.data[i]["name"]) {
                            case 0:
                                this.chartItemData.name = '未发货';
                                break;
                            case 1:
                                this.chartItemData.name = '已发货';
                                break;
                            case 2:
                                this.chartItemData.name = '已签收';
                                break;
                        }
                        this.chartItemData.value = resp.data[i]["value"];

                        this.salesData[i] = JSON.parse(JSON.stringify(this.chartItemData));
                    }
                    //console.log(this.salesData)
                });
                axios({
                    method: "get",
                    url: "http://localhost:8080/Mall/order/sortByGoods",
                }).then((resp) => {
                    for (let i = 0; i < resp.data.length; i++) {
                        this.chartItemData.name = resp.data[i]["name"];
                        this.chartItemData.value = resp.data[i]["value"];

                        this.goodsData[i] = JSON.parse(JSON.stringify(this.chartItemData));
                    }
                    //console.log(this.goodsData)
                });
                axios({
                    method: "get",
                    url: "http://localhost:8080/Mall/order/sortByType",
                }).then((resp) => {
                    for (let i = 0; i < resp.data.length; i++) {
                        this.chartItemData.name = resp.data[i]["name"];
                        this.chartItemData.value = resp.data[i]["value"];

                        this.typeData[i] = JSON.parse(JSON.stringify(this.chartItemData));
                    }
                    //console.log(this.typeData)
                });
                axios({
                    method: "get",
                    url: "http://localhost:8080/Mall/order/sortByUser",
                }).then(async (resp) => {
                    for (let i = 0; i < resp.data.length; i++) {
                        // 异步查询
                        await this.getUsername(resp.data[i]["name"]).then(res => {
                            this.chartItemData.name = res;
                        })

                        this.chartItemData.value = resp.data[i]["value"];

                        this.userData[i] = JSON.parse(JSON.stringify(this.chartItemData));

                    }
                    //console.log(this.userData)
                });
            },

            drawLine() {
                this.orderChart = this.$echarts.init(document.getElementById('orderChart'))
                this.salesChart = this.$echarts.init(document.getElementById('salesChart'))
                this.goodsChart = this.$echarts.init(document.getElementById('goodsChart'))
                this.typeChart = this.$echarts.init(document.getElementById('typeChart'))
                this.userChart = this.$echarts.init(document.getElementById('userChart'))

                let colorList = [
                    '#5470c6',
                    '#91cc75',
                    '#fac858',
                    '#ee6666',
                    '#73c0de',
                    '#3ba272',
                    '#fc8452',
                    '#9a60b4',
                    '#ea7ccc',
                ];
                let colorIndex = 0;

                this.orderChart.setOption({
                    title: {
                        text: '全部订单', // 主标题
                        subtext: '销售状态', // 副标题
                        x: 'left' // x轴方向对齐方式
                    },
                    grid: {containLabel: true},
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c}个 ({d}%)'
                    },
                    series: [
                        {
                            name: '订单状态',
                            type: 'pie',
                            radius: ['50%', '70%'],
                            avoidLabelOverlap: true,
                            center: ['50%', '50%'],
                            itemStyle: {
                                emphasis: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                },
                                color() {
                                    if (colorIndex === colorList.length) {
                                        colorIndex = 0
                                    }
                                    return colorList[colorIndex++]
                                }
                            },
                            label: {
                                normal: {
                                    textStyle: {
                                        fontSize: 16,
                                    }
                                }
                            },
                            data: this.orderData
                        }
                    ]
                })
                this.salesChart.setOption({
                    title: {
                        text: '全部订单', // 主标题
                        subtext: '销售额', // 副标题
                        x: 'left' // x轴方向对齐方式
                    },
                    grid: {containLabel: true},
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: ￥{c} ({d}%)'
                    },
                    series: [
                        {
                            name: '订单金额',
                            type: 'pie',
                            radius: ['50%', '70%'],
                            avoidLabelOverlap: true,
                            center: ['50%', '50%'],
                            itemStyle: {
                                emphasis: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                },
                                color() {
                                    if (colorIndex === colorList.length) {
                                        colorIndex = 0
                                    }
                                    return colorList[colorIndex++]
                                }
                            },
                            label: {
                                normal: {
                                    textStyle: {
                                        fontSize: 16,
                                    }
                                }
                            },
                            data: this.salesData
                        }
                    ]
                })
                this.goodsChart.setOption({
                    title: {
                        text: '商品统计', // 主标题
                        subtext: '销售额', // 副标题
                        x: 'left' // x轴方向对齐方式
                    },
                    grid: {containLabel: true},
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: ￥{c} ({d}%)'
                    },
                    series: [
                        {
                            name: '商品名称',
                            type: 'pie',
                            radius: ['50%', '70%'],
                            avoidLabelOverlap: true,
                            center: ['50%', '60%'],
                            itemStyle: {
                                emphasis: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                },
                                color() {
                                    if (colorIndex === colorList.length) {
                                        colorIndex = 0
                                    }
                                    return colorList[colorIndex++]
                                }
                            },
                            label: {
                                normal: {
                                    textStyle: {
                                        fontSize: 16,
                                    }
                                }
                            },
                            data: this.goodsData
                        }
                    ]
                })
                this.typeChart.setOption({
                    title: {
                        text: '类别统计', // 主标题
                        subtext: '销售额', // 副标题
                        x: 'left' // x轴方向对齐方式
                    },
                    grid: {containLabel: true},
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: ￥{c} ({d}%)'
                    },
                    series: [
                        {
                            name: '商品类别',
                            type: 'pie',
                            radius: ['50%', '70%'],
                            avoidLabelOverlap: true,
                            center: ['50%', '60%'],
                            itemStyle: {
                                emphasis: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                },
                                color() {
                                    if (colorIndex === colorList.length) {
                                        colorIndex = 0
                                    }
                                    return colorList[colorIndex++]
                                }
                            },
                            label: {
                                normal: {
                                    textStyle: {
                                        fontSize: 16,
                                    }
                                }
                            },
                            data: this.typeData
                        }
                    ]
                })
                this.userChart.setOption({
                    title: {
                        text: '用户统计', // 主标题
                        subtext: '购买金额', // 副标题
                        x: 'left' // x轴方向对齐方式
                    },
                    grid: {containLabel: true},
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: ￥{c} ({d}%)'
                    },
                    series: [
                        {
                            name: '用户名',
                            type: 'pie',
                            radius: ['50%', '70%'],
                            avoidLabelOverlap: true,
                            center: ['50%', '60%'],
                            itemStyle: {
                                emphasis: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                },
                                color() {
                                    if (colorIndex === colorList.length) {
                                        colorIndex = 0
                                    }
                                    return colorList[colorIndex++]
                                }
                            },
                            label: {
                                normal: {
                                    textStyle: {
                                        fontSize: 16,
                                    }
                                }
                            },
                            data: this.userData
                        }
                    ]
                })
            }

        },

    })
</script>
</body>

</html>